{{- $css := "" -}}
{{- $options := dict "targetPath" "main.css" "includePaths" (slice "node_modules") -}}

{{- if eq hugo.Environment "development" -}}
  {{- $options = merge $options (dict "transpiler" "libsass" "enableSourceMap" true) -}}
  {{- $css = resources.Get .src | toCSS $options | fingerprint "sha512" -}}
{{- else -}}
  {{- $options = merge $options (dict "transpiler" "libsass" "outputStyle" "compressed") -}}
  {{- /* We remove PostProcess here to ensure integrity hashes are calculated correctly with preload */ -}}
  {{- $css = resources.Get .src | toCSS $options | postCSS (dict "config" "config/postcss.config.js") | fingerprint "sha512" -}}
{{- end -}}

{{- if .ctx.IsHome -}}
  <style>{{ $css.Content | safeCSS }}</style>
{{- else -}}
  <link rel="stylesheet" href="{{ $css.RelPermalink }}" integrity="{{ $css.Data.Integrity }}" crossorigin="anonymous">
{{- end -}}
